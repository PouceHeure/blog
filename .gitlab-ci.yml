image: registry.gitlab.com/pages/hugo:latest

stages:
  - build
  - deploy

variables:
  HUGO_OUTPUT_DIR: "public"

cache:
  paths:
    - .hugo_cache/

default:
  tags:
    - docker

before_script:
  - apk add --no-cache openssh-client git # install ssh tools
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - ssh-keyscan github.com >> ~/.ssh/known_hosts
  - chmod 644 ~/.ssh/known_hosts

build:
  stage: build
  script:
    - git submodule sync --recursive
    - git submodule update --init --recursive
    - hugo
  artifacts:
    paths:
      - ${HUGO_OUTPUT_DIR}
  only:
    - main

pages:
  stage: deploy
  script:
    - echo "Deployment step"
  artifacts:
    paths:
      - public
  only:
    - main
